<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ch√° de Casa Nova - Andrielle</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  :root{--pink-1:#ff2d92;--pink-2:#ff6db7;--bg:#fff6fb;--card:#ffffff;--text:#333;}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Poppins',sans-serif;background:linear-gradient(180deg,#fff0f7 0%, #fff6fb 35%, #fff 100%);color:var(--text); padding-bottom: 80px;}
  
  /* SPLASH SCREEN */
  .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#000000,#1c1c1c);z-index:9999;flex-direction:column; transition: opacity 0.8s ease;}
  .splash .logo-spin{width:200px;height:200px;border-radius:20px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#000;box-shadow:0 30px 80px rgba(0,0,0,0.6)}
  .splash img{width:140px;height:140px;border-radius:50%;object-fit:cover;animation:logoSpin 1.1s cubic-bezier(.2,.9,.3,1) infinite}
  @keyframes logoSpin{0%{transform:rotateY(0) scale(1)}50%{transform:rotateY(180deg) scale(1.05)}100%{transform:rotateY(360deg) scale(1)}}
  .splash h2{color:white;margin-top:18px;font-size:20px;letter-spacing:2px}
  
  /* HEADER */
  header{padding:20px;background:linear-gradient(135deg,var(--pink-1),var(--pink-2));color:white;border-bottom-left-radius:25px;border-bottom-right-radius:25px;box-shadow:0 10px 30px rgba(255, 45, 146, 0.3);}
  .header-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;}
  .brand{display:flex;align-items:center;gap:15px;}
  .logo-small{width:60px;height:60px;border-radius:50%;object-fit:cover;border:3px solid white;}
  .title{font-size:20px;font-weight:700;line-height:1.2;}
  .subtitle{font-size:12px;opacity:0.9;}
  
  .login-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.4);padding:8px 16px;border-radius:20px;color:white;font-weight:600;cursor:pointer;font-size:12px;}
  .admin-indicator{background:#fff;color:var(--pink-1);padding:5px 12px;border-radius:20px;font-weight:700;font-size:12px;display:none;}

  /* MAIN */
  main{max-width:1100px;margin:20px auto;padding:15px;}
  
  /* BARRA DE PESQUISA */
  .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:20px;background:white;padding:10px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.03);}
  .search{flex:1;padding:12px;border:none;outline:none;font-size:14px;background:transparent;}
  .total-pill{background:#f3f3f3;color:#666;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:600;}
  .add-item-btn{background:var(--pink-1);color:white;border:none;padding:8px 15px;border-radius:10px;font-weight:600;cursor:pointer;font-size:12px;}

  /* LISTA E CARDS */
  .cat-title{color:var(--pink-1);font-size:20px;margin:25px 0 15px;font-weight:700;border-left:4px solid var(--pink-1);padding-left:10px;}
  
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:15px;}
  
  /* CARD STYLE - √çCONE ESQUERDA (LAYOUT QUADRADO) */
  .card{
    display:flex;
    align-items:center; /* Centraliza verticalmente */
    background:white;
    padding:12px;
    border-radius:16px;
    box-shadow:0 4px 15px rgba(0,0,0,0.04);
    border:1px solid transparent;
    transition:all 0.2s;
    cursor:pointer;
    margin-bottom: 15px; /* Espa√ßo entre itens */
  }
  .card:hover{transform:translateY(-3px);border-color:#ffcae4;}
  .card.full{opacity:0.7;}

  /* QUADRADO DO √çCONE */
  .icon-box{
    width:65px;
    height:65px;
    min-width:65px;
    background:linear-gradient(135deg, #fff0f7, #ffe6f2);
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:28px;
    margin-right:15px; /* Espa√ßo entre √≠cone e texto */
    border:1px solid rgba(0,0,0,0.03);
  }

  .card-content{flex:1;}
  .item-name{font-weight:700;font-size:15px;color:#222;margin-bottom:4px;}
  
  .reserved-info{font-size:11px;color:#666;background:#f9f9f9;padding:4px 8px;border-radius:6px;margin-top:4px;display:inline-block;}
  .reserved-info strong{color:var(--pink-1);}

  /* AREA QUANTIDADE */
  .qty-box{text-align:center;min-width:60px;display:flex;flex-direction:column;align-items:flex-end;}
  .badge{background:#e0e0e0;color:#555;padding:5px 10px;border-radius:8px;font-size:13px;font-weight:700;}
  .badge.available{background:linear-gradient(135deg,#00c853,#009624);color:white;}
  .esgotado-txt{color:#ff2d55;font-size:10px;font-weight:800;margin-top:5px;text-transform:uppercase;border:1px solid #ff2d55;padding:2px 5px;border-radius:4px;}

  /* ADMIN BUTTONS */
  .admin-actions{display:flex;gap:5px;margin-top:5px;}
  .btn-adm{width:24px;height:24px;border-radius:6px;border:none;background:#eee;color:#333;cursor:pointer;font-weight:bold;}
  .btn-adm:hover{background:#ccc;}

  /* MODALS */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:10000;}
  .modal{background:white;width:90%;max-width:450px;padding:25px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.2);}
  .modal h3{color:var(--pink-1);margin-bottom:15px;}
  
  input{width:100%;padding:14px;border:1px solid #eee;border-radius:12px;margin-bottom:10px;font-family:inherit;background:#fafafa;}
  
  .btn-row{display:flex;gap:10px;margin-top:15px;}
  .btn{flex:1;padding:14px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:14px;}
  .btn-primary{background:var(--pink-1);color:white;}
  .btn-sec{background:#f0f0f0;color:#444;}

  footer{text-align:center;padding:20px;color:#888;font-size:12px;max-width:600px;margin:0 auto;}
</style>
</head>
<body>

<div id="splash" class="splash">
  <div class="logo-spin"><img src="logo.png" alt="Logo"></div>
  <h2 style="margin-top:20px;">Carregando Lista...</h2>
</div>

<header>
  <div class="header-inner">
    <div class="brand">
      <img src="logo.png" class="logo-small" alt="AT">
      <div>
        <div class="title">Andrielle Telles</div>
        <div class="subtitle">Ch√° de Casa Nova</div>
      </div>
    </div>
    <div>
      <button id="loginBtn" class="login-btn">Sou Admin</button>
      <span id="adminTag" class="admin-indicator">MODO ADMIN</span>
    </div>
  </div>
</header>

<main>
  <div class="topbar">
    <i class="fa fa-search" style="color:#ccc;margin-left:5px;"></i>
    <input id="search" class="search" placeholder="O que voc√™ procura?" oninput="searchItem()">
    <div class="total-pill"><span id="totalCount">0</span> itens</div>
    <button id="addItemBtn" class="add-item-btn" style="display:none">+ Item</button>
  </div>

  <div id="emptyState" style="display:none;text-align:center;padding:40px;">
    <p style="color: #666; margin-bottom: 10px;">A lista est√° vazia.</p>
    <p style="font-size: 12px; color: #999;">Se voc√™ acabou de criar o banco, importe o JSON conforme o tutorial ou adicione itens manualmente.</p>
  </div>

  <div id="lists"></div>
</main>

<div id="loginModal" class="modal-bg">
  <div class="modal">
    <h3>√Årea da Noiva</h3>
    <input id="user" placeholder="Usu√°rio">
    <input id="pass" type="password" placeholder="Senha">
    <div class="btn-row">
      <button class="btn btn-sec" id="closeLogin">Cancelar</button>
      <button class="btn btn-primary" id="confirmLogin">Entrar</button>
    </div>
  </div>
</div>

<div id="reserveModal" class="modal-bg">
  <div class="modal">
    <h3>Reservar Presente</h3>
    <p style="margin-bottom:15px;color:#666;font-size:14px;">Voc√™ est√° reservando: <strong id="resItemName" style="color:#333">Item</strong></p>
    
    <input id="resNome" placeholder="Seu Nome Completo *">
    <input id="resTel" placeholder="Seu Telefone (WhatsApp) *">
    <input id="resEnd" placeholder="Seu Endere√ßo *">
    
    <div class="btn-row">
      <button class="btn btn-sec" id="closeRes">Cancelar</button>
      <button class="btn btn-primary" id="confirmRes">Confirmar</button>
    </div>
  </div>
</div>

<div id="addModal" class="modal-bg">
  <div class="modal">
    <h3>Novo Item</h3>
    <input id="newItemName" placeholder="Nome do Item">
    <input id="newItemCat" placeholder="Categoria (Cozinha, Banheiro...)">
    <input id="newItemQty" type="number" placeholder="Quantidade">
    <input id="newItemEmoji" placeholder="Emoji">
    <div class="btn-row">
      <button class="btn btn-sec" id="closeAdd">Cancelar</button>
      <button class="btn btn-primary" id="confirmAdd">Salvar</button>
    </div>
  </div>
</div>

<footer>
  Verifique os itens antes de selecionar. Em caso de d√∫vida entre em contato com a Andrielle.
</footer>

<script>
/* --- CONFIGURA√á√ÉO (LINK ATUALIZADO) --- */
const firebaseConfig = {
  // URL DO NOVO PROJETO FORNECIDA PELO USU√ÅRIO
  databaseURL: "https://cha-andrielle-oficial-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// NOME DA LISTA NO BANCO (Deve ser o mesmo do JSON importado: items_final)
const itemsRef = db.ref('items_final');

const TELEGRAM_TOKEN = '8559140827:AAHxA4d-MvDH-BanHYymnK2UKLRWM3KJrec';
const TELEGRAM_CHAT_ID = '-1003451773752';
const ADMIN_USER = 'jvpacheco845';
const ADMIN_PASS = '22demaio';

let allItems = [];
let isAdmin = false;

/* --- INICIALIZA√á√ÉO --- */
window.addEventListener('load', ()=>{
  setTimeout(()=>{
    document.getElementById('splash').style.opacity=0;
    setTimeout(()=>document.getElementById('splash').remove(), 800);
  }, 4000);
});

// Monitorar dados do Firebase
itemsRef.on('value', (snapshot) => {
  const val = snapshot.val();
  const listContainer = document.getElementById('lists');
  
  if(!val){
    // Se estiver vazio
    document.getElementById('emptyState').style.display = 'block';
    listContainer.innerHTML = '';
    document.getElementById('totalCount').innerText = '0';
    return;
  }

  document.getElementById('emptyState').style.display = 'none';
  
  // Converter para array (suporta importa√ß√£o via JSON que usa IDs num√©ricos ou push keys)
  allItems = Object.entries(val).map(([k, v]) => ({
    id: k,
    ...v,
    peopleList: v.people ? Object.values(v.people) : []
  }));

  render(allItems);
}, (error) => {
  alert("Erro de acesso ao Banco de Dados: " + error.message + "\nVerifique se voc√™ publicou as REGRAS no Console do Firebase.");
});

/* --- RENDERIZA√á√ÉO --- */
function render(list) {
  const container = document.getElementById('lists');
  container.innerHTML = '';

  // Ordenar categorias
  const catOrder = {'Cozinha':1, 'Banheiro':2, 'Quarto':3, '√Årea de Servi√ßo':4};
  list.sort((a,b) => (catOrder[a.cat]||99) - (catOrder[b.cat]||99));

  // Atualizar Total
  const total = list.reduce((acc, cur) => acc + (parseInt(cur.qty)||0), 0);
  document.getElementById('totalCount').innerText = total;

  let curCat = '';

  list.forEach(item => {
    // Cabe√ßalho Categoria
    if(item.cat !== curCat){
      curCat = item.cat;
      const h = document.createElement('div');
      h.className = 'cat-title';
      h.innerText = curCat;
      container.appendChild(h);
    }

    const reservedCount = item.peopleList.length;
    const isFull = reservedCount >= item.qty;

    // HTML DO CARD
    const div = document.createElement('div');
    div.className = `card ${isFull ? 'full' : ''}`;
    
    div.innerHTML = `
      <div class="icon-box">${item.emoji || 'üéÅ'}</div>
      
      <div class="card-content">
        <div class="item-name">${item.name}</div>
        ${reservedCount > 0 ? 
          `<div class="reserved-info">Reservado por: <strong>${item.peopleList.join(', ')}</strong></div>` 
          : ''}
      </div>

      <div class="qty-box">
        <div class="badge ${!isFull ? 'available' : ''}">${reservedCount}/${item.qty}</div>
        ${isFull ? '<div class="esgotado-txt">Esgotado</div>' : ''}
        
        ${isAdmin ? `
        <div class="admin-actions">
          <button class="btn-adm" onclick="changeQty('${item.id}', -1, event)">-</button>
          <button class="btn-adm" onclick="changeQty('${item.id}', 1, event)">+</button>
        </div>` : ''}
      </div>
    `;

    // Click Event
    div.onclick = (e) => {
      // Se clicar nos bot√µes de admin, n√£o abre modal
      if(e.target.tagName === 'BUTTON') return;
      
      if(isAdmin) return;
      if(isFull) return alert("Este item j√° foi totalmente reservado!");
      
      openReserveModal(item);
    };

    container.appendChild(div);
  });
}

/* --- L√ìGICA RESERVA --- */
let selectedItem = null;
const resModal = document.getElementById('reserveModal');

function openReserveModal(item){
  selectedItem = item;
  document.getElementById('resItemName').innerText = item.name;
  document.getElementById('resNome').value = '';
  document.getElementById('resTel').value = '';
  document.getElementById('resEnd').value = '';
  resModal.style.display = 'flex';
}

document.getElementById('closeRes').onclick = () => resModal.style.display = 'none';

document.getElementById('confirmRes').onclick = () => {
  const nome = document.getElementById('resNome').value.trim();
  const tel = document.getElementById('resTel').value.trim();
  const end = document.getElementById('resEnd').value.trim();

  if(!nome || !tel || !end) return alert("Preencha todos os campos!");

  // Verifica disponibilidade novamente
  itemsRef.child(selectedItem.id).once('value', snap => {
    const val = snap.val();
    const currentRes = val.people ? Object.keys(val.people).length : 0;

    if(currentRes >= val.qty){
      alert("Algu√©m acabou de pegar a √∫ltima unidade! :(");
      resModal.style.display = 'none';
      return;
    }

    // Salva
    itemsRef.child(selectedItem.id).child('people').push(nome);
    
    // Telegram
    sendTelegram(`üéÅ *NOVA RESERVA*\nItem: ${selectedItem.name}\nNome: ${nome}\nTel: ${tel}\nEnd: ${end}`);
    
    resModal.style.display = 'none';
    alert("Reserva Confirmada!");
  });
};

/* --- L√ìGICA ADMIN --- */
const loginModal = document.getElementById('loginModal');
document.getElementById('loginBtn').onclick = () => loginModal.style.display = 'flex';
document.getElementById('closeLogin').onclick = () => loginModal.style.display = 'none';

document.getElementById('confirmLogin').onclick = () => {
  const u = document.getElementById('user').value;
  const p = document.getElementById('pass').value;
  
  if(u === ADMIN_USER && p === ADMIN_PASS){
    isAdmin = true;
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('adminTag').style.display = 'block';
    document.getElementById('addItemBtn').style.display = 'block';
    loginModal.style.display = 'none';
    render(allItems); // Re-render para mostrar bot√µes +/-
  } else {
    alert("Acesso Negado");
  }
};

// Change Qty & Remove User if needed
function changeQty(id, delta, event){
  event.stopPropagation();
  const item = allItems.find(i => i.id === id);
  const newQty = (parseInt(item.qty)||0) + delta;
  if(newQty < 0) return;

  const currentRes = item.peopleList.length;

  if(newQty < currentRes){
    // Precisa remover o √∫ltimo
    itemsRef.child(id).child('people').limitToLast(1).once('value', snap => {
      snap.forEach(child => {
        const name = child.val();
        child.ref.remove(); // Remove do DB
        itemsRef.child(id).update({qty: newQty}); // Atualiza Qtd
        sendTelegram(`‚ö†Ô∏è *RESERVA REMOVIDA PELO ADMIN*\nItem: ${item.name}\nNome Removido: ${name}`);
      });
    });
  } else {
    // Apenas atualiza qtd
    itemsRef.child(id).update({qty: newQty});
  }
}

/* --- ADD ITEM (ADMIN) --- */
const addModal = document.getElementById('addModal');
document.getElementById('addItemBtn').onclick = () => addModal.style.display = 'flex';
document.getElementById('closeAdd').onclick = () => addModal.style.display = 'none';

document.getElementById('confirmAdd').onclick = () => {
  const name = document.getElementById('newItemName').value;
  const cat = document.getElementById('newItemCat').value;
  const qty = document.getElementById('newItemQty').value;
  const emoji = document.getElementById('newItemEmoji').value || 'üéÅ';

  if(name && cat && qty){
    itemsRef.push({name, cat, qty: parseInt(qty), emoji, people:{}});
    addModal.style.display = 'none';
  } else {
    alert("Preencha tudo");
  }
};

/* --- SEARCH --- */
function searchItem(){
  const term = document.getElementById('search').value.toLowerCase();
  if(!term) return render(allItems);
  const filtered = allItems.filter(i => i.name.toLowerCase().includes(term) || i.cat.toLowerCase().includes(term));
  render(filtered);
}

/* --- TELEGRAM --- */
async function sendTelegram(text){
  try {
    await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({chat_id: TELEGRAM_CHAT_ID, text, parse_mode:'Markdown'})
    });
  } catch(e){ console.error(e); }
}

/* --- FECHAR MODAL CLICK FORA --- */
document.querySelectorAll('.modal-bg').forEach(el => {
  el.addEventListener('click', e => { if(e.target === el) el.style.display = 'none'; });
});

</script>
</body>
</html>
